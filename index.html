<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>YKS / LGS PUAN ve YÜZDELİK SİMÜLATÖRÜ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO (hafif) -->
  <meta name="description" content="2026 YKS hazırlığında deneme netlerinle 2025 YKS puan ve sıralamanı (SAY/EA/SÖZ/DİL) simüle et. OBP ile yerleştirme puanı ve sıralama hesaplama." />

  <style>
    :root{
      --page-w: 380px;
      --control-w: 260px;
      --radius: 10px;
    }
    body{
      font-family: Arial, sans-serif;
      max-width: 420px;
      margin: 24px auto;
      padding: 12px;
      text-align: center;
      background: #fff;
    }
    .heroTitle{
      font-weight: 800;
      font-size: 22px;
      margin: 10px 0 8px;
      letter-spacing: 0.2px;
    }
    .heroSub{
      font-size: 13px;
      opacity: .85;
      margin: 0 0 10px;
      line-height: 1.4;
    }
    .bgWrap{
      position: fixed;
      inset: 0;
      background: url("umut.jpeg") center/cover no-repeat;
      z-index: -2;
      filter: blur(0px);
    }
    .bgOverlay{
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.72);
      z-index: -1;
    }

    label{
      display:block;
      margin: 12px auto 6px;
      font-weight: 700;
      width: var(--control-w);
      text-align:left;
    }
    select, input{
      width: var(--control-w);
      padding: 10px 12px;
      border: 1px solid #bfbfbf;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
      background: #fff;
    }
    .hint{
      font-size: 12px;
      opacity:.75;
      margin-top:6px;
    }
    .sectionTitle{
      margin: 18px 0 8px;
      font-weight: 800;
      font-size: 14px;
      opacity: .9;
    }
    .card{
      margin: 10px auto;
      width: calc(var(--control-w) + 40px);
      background: rgba(255,255,255,0.45);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 10px;
      padding: 12px 10px;
      box-sizing: border-box;
    }
    .btn{
      width: var(--control-w);
      padding: 12px 14px;
      font-weight: 800;
      border: 1px solid #222;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      margin: 12px 0 6px;
    }
    .result{
      margin-top: 12px;
      font-weight: 800;
    }
    .disclaimer{
      width: calc(var(--control-w) + 40px);
      margin: 10px auto 0;
      font-size: 12px;
      opacity: .85;
      line-height: 1.35;
    }
    a{ color:#0b57d0; }

    /* Paylaş modal (mevcut) */
    .modalBack{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      box-sizing:border-box;
      z-index: 999;
    }
    .modal{
      width: min(420px, 100%);
      background:#fff;
      border-radius: 12px;
      padding: 14px;
      box-sizing:border-box;
      text-align:left;
    }
    .modalTitle{
      font-weight: 800;
      margin: 0 0 8px;
    }
    .modalText{
      width: 100%;
      min-height: 110px;
      border:1px solid #cfcfcf;
      border-radius: 8px;
      padding: 10px;
      box-sizing:border-box;
      font-size: 13px;
      line-height: 1.35;
      resize: vertical;
    }
    .modalBtns{
      display:flex;
      gap:10px;
      margin-top: 10px;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .modalBtn{
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #222;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-weight: 800;
    }
    .modalBtnLight{
      background:#fff;
      color:#111;
      border:1px solid #bfbfbf;
    }

    /* === SINAV TÜRÜ (YKS/LGS) === */
    .examSwitchWrap{ margin: 10px auto 14px; width: var(--control-w); text-align:left; }
    .examLabel{ font-weight:700; margin-bottom:6px; }
    .examSwitch{ display:flex; gap:10px; }
    .examBtn{
      flex:1;
      padding:10px 12px;
      border:1px solid #bfbfbf;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      border-radius: 6px;
    }
    .examBtn.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .examBtn.lgsActive{ background:#ededed; color:#111; border-color:#bfbfbf; }

    /* === LGS GRID (Excel Sayfa3 hissi) === */
    .lgsGridHead{
      display:grid;
      grid-template-columns: 1.6fr .8fr .8fr .8fr;
      gap:10px;
      background:#e6e6e6;
      padding:10px;
      border:1px solid #cfcfcf;
      font-weight:700;
      margin-top:10px;
      width: calc(var(--control-w) + 40px);
      margin-left:auto;
      margin-right:auto;
      box-sizing:border-box;
      text-align:left;
    }
    .lgsRows{
      width: calc(var(--control-w) + 40px);
      margin: 0 auto;
      border-left:1px solid #cfcfcf;
      border-right:1px solid #cfcfcf;
      box-sizing:border-box;
      text-align:left;
    }
    .lgsRow{
      display:grid;
      grid-template-columns: 1.6fr .8fr .8fr .8fr;
      gap:10px;
      padding:10px;
      border-bottom:1px solid #cfcfcf;
      background: rgba(255,255,255,0.75);
      box-sizing:border-box;
    }
    .lgsRow:nth-child(even){ background: rgba(255,255,255,0.55); }
    .lgsTestName{ font-weight:700; display:flex; align-items:center; }
    .smallInput{
      width:100%;
      padding:10px 10px;
      border:1px solid #bfbfbf;
      border-radius:6px;
      font-size:14px;
      box-sizing:border-box;
      background:#fff;
    }
    .lgsTotals{
      width: calc(var(--control-w) + 40px);
      margin: 0 auto 10px;
      display:grid;
      grid-template-columns: 1.6fr .8fr .8fr .8fr;
      gap:10px;
      padding:10px;
      border:1px solid #cfcfcf;
      background:#f2f2f2;
      box-sizing:border-box;
      text-align:left;
    }
    .lgsTotalsLabel{ font-weight:800; display:flex; align-items:center; }

    .lgsKpi{
      width: calc(var(--control-w) + 40px);
      margin: 6px auto 0;
      text-align:left;
    }
    .kpiRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
      margin:8px 0;
    }
    .kpiLabel{ font-weight:800; }

    .listTitle{
      width: calc(var(--control-w) + 40px);
      margin:14px auto 8px;
      font-weight:800;
      font-size:13px;
      text-align:left;
    }
    .schoolTableWrap{
      width: calc(var(--control-w) + 40px);
      margin: 0 auto;
      overflow:auto;
      border:1px solid #cfcfcf;
      background: rgba(255,255,255,0.65);
      box-sizing:border-box;
    }
    .schoolTable{ width:100%; border-collapse:collapse; min-width:720px; }
    .schoolTable th, .schoolTable td{
      border-bottom:1px solid #d9d9d9;
      padding:10px;
      vertical-align:top;
      font-size:13px;
      text-align:left;
    }
    .schoolTable thead th{ background:#e6e6e6; position:sticky; top:0; }
    .colNum{ width:110px; text-align:right; }
    .colTrend{ width:220px; }
    .colOkul{ min-width:260px; }

    .schoolName{ white-space:nowrap; }
    @media (max-width: 480px){
      .schoolTable{ min-width:520px; }
      .schoolName{ white-space:normal; word-break:break-word; }
    }

    /* === LGS: TALEP RENKLERİ (Excel mantığı: DÜŞÜŞ=yeşil, ARTIŞ=kırmızı) === */
    .trendUp{
      background: rgba(255, 228, 228, 0.9);
      color:#5a0000;
      font-weight:700;
    }
    .trendDown{
      background: rgba(224, 245, 224, 0.9);
      color:#0b3d0b;
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="bgWrap"></div>
  <div class="bgOverlay"></div>

  <div class="heroTitle">YKS 2025 PUAN VE SIRA<br/>SİMÜLATÖRÜ</div>

  <div class="heroSub">
    2026 YKS hazırlığınızı sürdürürken deneme sınavlarında ürettiğiniz netlerin,
    sizi 2025 YKS'de kaç puanla hangi puan türünde kaçıncı yapacağını görmek için
    bu PUAN ve SIRALAMA simülatörünü yıl boyunca kullanmaya devam edin.
    <br/><br/>
    OBP kısmına güncel OBP'nizi yazarak 2025 YKS YERLEŞTİRME PUANINIZI ve
    SIRALAMANIZI %99,5 oranında doğru hesaplayacaktır.
  </div>

  <div style="margin-top:10px;">
    <a href="https://instagram.com/umutsahin.tr" target="_blank" rel="noopener">
      instagram.com/umutsahin.tr
    </a>
  </div>

  <div class="disclaimer">
    Bu sonuçlar bir <b>simülasyondur</b>. Gerçek YKS sonuçları; sınavın zorluk düzeyi,
    standart sapma ve ÖSYM hesaplamalarına göre değişebilir.
  </div>

  <div id="yksPanel">
    <div class="examSwitchWrap">
      <div class="examLabel">Sınav Türü</div>
      <div class="examSwitch" role="tablist" aria-label="Sınav Türü">
        <button id="btnYks" type="button" class="examBtn active" role="tab" aria-selected="true">YKS</button>
        <button id="btnLgs" type="button" class="examBtn" role="tab" aria-selected="false">LGS</button>
      </div>
    </div>

    <label>Puan Türü</label>
    <select id="puanTuru">
      <option value="SAY">SAY</option>
      <option value="EA">EA</option>
      <option value="SOZ">SÖZ</option>
      <option value="DIL">DİL</option>
    </select>

    <label>OBP (0–100)</label>
    <input id="obp" type="number" step="0.01" placeholder="Örn: 85,50" />
    <div class="hint">Virgül veya nokta ile yazabilirsin.</div>

    <div class="card">
      <div class="sectionTitle">TYT Netleri</div>

      <label style="width:var(--control-w); margin-top:8px;">TYT Türkçe</label>
      <input id="tytTurkce" type="number" step="0.01" placeholder="" />

      <label style="width:var(--control-w);">TYT Sosyal</label>
      <input id="tytSosyal" type="number" step="0.01" placeholder="" />

      <label style="width:var(--control-w);">TYT Matematik</label>
      <input id="tytMat" type="number" step="0.01" placeholder="" />

      <label style="width:var(--control-w);">TYT Fen</label>
      <input id="tytFen" type="number" step="0.01" placeholder="" />
    </div>

    <div class="card">
      <div class="sectionTitle" id="aytTitle">AYT (SAY)</div>

      <label style="width:var(--control-w); margin-top:8px;" id="ayt1Label">AYT Matematik</label>
      <input id="ayt1" type="number" step="0.01" placeholder="" />

      <label style="width:var(--control-w);" id="ayt2Label">AYT Fizik</label>
      <input id="ayt2" type="number" step="0.01" placeholder="" />

      <label style="width:var(--control-w);" id="ayt3Label">AYT Kimya</label>
      <input id="ayt3" type="number" step="0.01" placeholder="" />

      <label style="width:var(--control-w);" id="ayt4Label">AYT Biyoloji</label>
      <input id="ayt4" type="number" step="0.01" placeholder="" />
    </div>

    <button class="btn" id="btnHesapla" type="button">HESAPLA</button>

    <div class="result" id="sonuc"></div>

    <div style="margin: 10px 0 0;">
      <button class="btn" id="btnPaylas" type="button" style="display:none;">Paylaş</button>
    </div>

    <div class="modalBack" id="modalBack">
      <div class="modal">
        <div class="modalTitle">Sonucu Paylaş</div>
        <textarea class="modalText" id="shareText" readonly></textarea>
        <div class="modalBtns">
          <button class="modalBtnLight modalBtn" id="btnCopy" type="button">Kopyala</button>
          <button class="modalBtn" id="btnShareNative" type="button">Paylaş</button>
          <button class="modalBtn modalBtnLight" id="btnCloseModal" type="button">Alanlara dön</button>
        </div>
      </div>
    </div>
  </div>

  <div id="lgsPanel" style="display:none;">
    <div class="sectionTitle">LGS 2025 PUAN ve YÜZDELİK SİMÜLATÖRÜ</div>

    <div class="lgsGridHead">
      <div>TEST</div><div>DOĞRU</div><div>YANLIŞ</div><div>NET</div>
    </div>

    <div class="lgsRows" id="lgsRows"></div>

    <div class="lgsTotals">
      <div class="lgsTotalsLabel">TOPLAM</div>
      <div><input id="lgsDogruTop" class="smallInput" type="text" readonly></div>
      <div><input id="lgsYanlisTop" class="smallInput" type="text" readonly></div>
      <div><input id="lgsNetTop" class="smallInput" type="text" readonly></div>
    </div>

    <div class="lgsKpi">
      <div class="kpiRow">
        <div class="kpiLabel">LGS PUANI</div>
        <input id="lgsPuan" type="text" readonly>
      </div>
      <div class="kpiRow">
        <div class="kpiLabel">GENEL YÜZDELİK DİLİMİ</div>
        <input id="lgsYuzdelik" type="text" readonly>
      </div>
      <div class="kpiRow">
        <div class="kpiLabel">İL SEÇİMİ</div>
        <select id="lgsIl"></select>
      </div>
    </div>

    <button id="btnLgsHesapla" class="btn" type="button">HESAPLA</button>

    <div id="lgsLists" style="display:none;">
      <div class="listTitle">BİRİNCİ YERLEŞTİRME DÖNEMİNDE YERLEŞEBİLECEĞİ LİSELER</div>
      <div class="schoolTableWrap">
        <table class="schoolTable" id="tblBirinci">
          <thead>
            <tr>
              <th class="colOkul">OKUL</th>
              <th class="colNum">TABAN PUAN</th>
              <th class="colNum">YÜZDELİK</th>
              <th class="colTrend">2025'TE ÖNCEKİ YILLARA GÖRE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="listTitle">SON NAKİL YERLEŞTİRME DÖNEMİNDE YERLEŞEBİLECEĞİ LİSELER</div>
      <div class="schoolTableWrap">
        <table class="schoolTable" id="tblNakil">
          <thead>
            <tr>
              <th class="colOkul">OKUL</th>
              <th class="colNum">TABAN PUAN</th>
              <th class="colNum">YÜZDELİK</th>
              <th class="colTrend">2025'TE ÖNCEKİ YILLARA GÖRE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="hint" id="lgsNote" style="margin-top:10px; opacity:.85;"></div>
  </div>

  <script src="app.js"></script>

  <script>
    (function(){
      // --- yardımcılar ---
      function num(v){
        if (v === null || v === undefined) return 0;
        if (typeof v === "number") return isFinite(v) ? v : 0;
        const s = String(v).trim().replace(",", ".");
        if (!s) return 0;
        const n = Number(s);
        return isFinite(n) ? n : 0;
      }

      function fmt(n, d=2){
        if (!isFinite(n)) return "";
        return n.toFixed(d).replace(".", ",");
      }

      // --- AYT etiketleri (mevcut) ---
      const puanTuru = document.getElementById("puanTuru");
      const aytTitle = document.getElementById("aytTitle");
      const ayt1Label = document.getElementById("ayt1Label");
      const ayt2Label = document.getElementById("ayt2Label");
      const ayt3Label = document.getElementById("ayt3Label");
      const ayt4Label = document.getElementById("ayt4Label");

      function setAytLabels(){
        const t = puanTuru.value;
        if (t === "SAY"){
          aytTitle.textContent = "AYT (SAY)";
          ayt1Label.textContent = "AYT Matematik";
          ayt2Label.textContent = "AYT Fizik";
          ayt3Label.textContent = "AYT Kimya";
          ayt4Label.textContent = "AYT Biyoloji";
        } else if (t === "EA"){
          aytTitle.textContent = "AYT (EA)";
          ayt1Label.textContent = "AYT Matematik";
          ayt2Label.textContent = "AYT Edebiyat";
          ayt3Label.textContent = "AYT Tarih-1";
          ayt4Label.textContent = "AYT Coğrafya-1";
        } else if (t === "SOZ"){
          aytTitle.textContent = "AYT (SÖZ)";
          ayt1Label.textContent = "AYT Edebiyat";
          ayt2Label.textContent = "AYT Tarih-1";
          ayt3Label.textContent = "AYT Coğrafya-1";
          ayt4Label.textContent = "AYT Felsefe Grubu";
        } else {
          aytTitle.textContent = "YDT (DİL)";
          ayt1Label.textContent = "YDT Dil";
          ayt2Label.textContent = "—";
          ayt3Label.textContent = "—";
          ayt4Label.textContent = "—";
        }
      }
      puanTuru.addEventListener("change", setAytLabels);
      setAytLabels();

      // --- mevcut YKS hesap (app.js çalışıyor; burada sadece UI/Paylaş modal var) ---
      const modalBack = document.getElementById("modalBack");
      const shareText = document.getElementById("shareText");
      const btnPaylas = document.getElementById("btnPaylas");
      const btnCopy = document.getElementById("btnCopy");
      const btnShareNative = document.getElementById("btnShareNative");
      const btnCloseModal = document.getElementById("btnCloseModal");

      function openModal(){
        modalBack.style.display = "flex";
      }
      function closeModal(){
        modalBack.style.display = "none";
      }

      btnCloseModal.addEventListener("click", closeModal);
      modalBack.addEventListener("click", (e)=>{
        if (e.target === modalBack) closeModal();
      });

      function getShareText(){
        const sonuc = document.getElementById("sonuc").textContent || "";
        const tur = document.getElementById("puanTuru").value || "";
        return `YKS 2025 Simülasyon Sonucu (${tur})\\n${sonuc}\\n\\nSimülatör: https://gerginix.github.io/yks-sira-puan-simulatoru/`;
      }

      btnPaylas.addEventListener("click", ()=>{
        shareText.value = getShareText();
        openModal();
      });

      btnCopy.addEventListener("click", async ()=>{
        try{
          await navigator.clipboard.writeText(shareText.value || "");
          btnCopy.textContent = "Kopyalandı";
          setTimeout(()=>btnCopy.textContent="Kopyala", 1200);
        }catch(e){
          btnCopy.textContent = "İzin yok";
          setTimeout(()=>btnCopy.textContent="Kopyala", 1200);
        }
      });

      btnShareNative.addEventListener("click", async ()=>{
        const txt = shareText.value || "";
        if (navigator.share){
          try{
            await navigator.share({ text: txt });
          }catch(e){}
        } else {
          btnShareNative.textContent = "Paylaşım desteklenmiyor";
          setTimeout(()=>btnShareNative.textContent="Paylaş", 1400);
        }
      });

      // Sonuç dolunca paylaş butonu görünsün (mevcut davranış)
      const sonucEl = document.getElementById("sonuc");
      const obs = new MutationObserver(()=>{
        const has = (sonucEl.textContent || "").trim().length > 0;
        btnPaylas.style.display = has ? "" : "none";
      });
      obs.observe(sonucEl, { childList:true, subtree:true, characterData:true });

    })();

    /* =========================
       LGS PANEL (lgs.json)
       - YKS koduna dokunmaz
       ========================= */
    (function(){
      const btnYks = document.getElementById("btnYks");
      const btnLgs = document.getElementById("btnLgs");

      const yksPanel = document.getElementById("yksPanel");
      const lgsPanel = document.getElementById("lgsPanel");

            function toggleYksFields(show){
        if (!yksPanel) return;

        // Menü (YKS/LGS butonları) HER ZAMAN görünür kalsın
        const switchWrap = yksPanel.querySelector(".examSwitchWrap");

        Array.from(yksPanel.children).forEach(el => {
          if (switchWrap && el === switchWrap) {
            el.style.display = ""; // ✅ asla gizlenmez
          } else {
            el.style.display = show ? "" : "none";
          }
        });
      }

      function setExam(mode){
        if (!btnYks || !btnLgs || !yksPanel || !lgsPanel) return;

        const isLgs = mode === "LGS";
        btnYks.classList.toggle("active", !isLgs);
        btnLgs.classList.toggle("active", isLgs);

        // LGS aktifken butonun pastel gri hissi
        btnLgs.classList.toggle("lgsActive", isLgs);
        btnYks.classList.toggle("lgsActive", false);

        btnYks.setAttribute("aria-selected", String(!isLgs));
        btnLgs.setAttribute("aria-selected", String(isLgs));

        // ✅ Kritik: YKS panelini komple saklama (menü kayboluyor). Sadece YKS alanlarını gizle.
        toggleYksFields(!isLgs);

        // LGS paneli aç/kapat
        lgsPanel.style.display = isLgs ? "" : "none";

        if (isLgs) lgs_initOnce();
      }

      btnYks && btnYks.addEventListener("click", () => setExam("YKS"));
      btnLgs && btnLgs.addEventListener("click", () => setExam("LGS"));

      // --- LGS motoru ---
      let lgsData = null;
      let lgsInited = false;

      const rowsWrap = document.getElementById("lgsRows");
      const ilSelect = document.getElementById("lgsIl");
      const btnCalc = document.getElementById("btnLgsHesapla");
      const noteEl = document.getElementById("lgsNote");
      const listsWrap = document.getElementById("lgsLists");

      const outDogru = document.getElementById("lgsDogruTop");
      const outYanlis = document.getElementById("lgsYanlisTop");
      const outNet = document.getElementById("lgsNetTop");
      const outPuan = document.getElementById("lgsPuan");
      const outYuz = document.getElementById("lgsYuzdelik");

      function fmt2(n){
        if (n === null || n === undefined || Number.isNaN(n)) return "";
        return Number(n).toFixed(2).replace(".", ",");
      }
      function fmtPuan(n){
        if (n === null || n === undefined || Number.isNaN(n)) return "";
        return Number(n).toFixed(2).replace(".", ",");
      }
      function toNum(v){
        if (v === null || v === undefined) return NaN;
        const s = String(v).trim().replace(",", ".");
        if (!s) return NaN;
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }
      function clamp(n, min, max){
        if (!Number.isFinite(n)) return NaN;
        return Math.min(max, Math.max(min, n));
      }

      function applyTrendColors(container){
        if (!container) return;
        const cells = container.querySelectorAll("[data-trend-cell]");
        cells.forEach(cell => {
          const t = (cell.textContent || "").toUpperCase();
          cell.classList.remove("trendUp","trendDown");
          if (t.includes("TALEP ARTIŞI")) cell.classList.add("trendUp");
          if (t.includes("TALEP DÜŞÜŞÜ")) cell.classList.add("trendDown");
        });
      }

      function lgs_initOnce(){
        if (lgsInited) return;
        lgsInited = true;

        fetch("lgs.json", { cache: "no-store" })
          .then(r => r.json())
          .then(data => {
            lgsData = data;
            buildLgsUI();
            noteEl.textContent = "";
          })
          .catch(err => {
            console.error(err);
            noteEl.textContent = "lgs.json okunamadı. Dosya repo kökünde mi? (lgs.json)";
          });
      }

      function buildLgsUI(){
        if (!lgsData || !rowsWrap || !ilSelect) return;

        // Satırları üret
        rowsWrap.innerHTML = "";
        const pickArr = (obj, keys) => { for (const k of keys){ const v = obj?.[k]; if (Array.isArray(v)) return v; } return []; };
    const testsRaw = pickArr(lgsData, ["testler","tests","dersler","subjects","oturumlar"]);
    // Eğer JSON test listesi farklıysa veya yoksa: LGS standart 6 test fallback
    const tests = testsRaw.length ? testsRaw : [
      { test:"Türkçe", max_dogru:20, katsayi:4 },
      { test:"Matematik", max_dogru:20, katsayi:4 },
      { test:"Fen", max_dogru:20, katsayi:4 },
      { test:"İnkılap", max_dogru:10, katsayi:1 },
      { test:"Din", max_dogru:10, katsayi:1 },
      { test:"Yabancı Dil", max_dogru:10, katsayi:1 },
    ];
        tests.forEach((t, i) => {
          const testName = t.test || ("TEST " + (i+1));
          const maxQ = Number(t.max_dogru ?? 0);

          const row = document.createElement("div");
          row.className = "lgsRow";
          row.dataset.test = testName;
          row.dataset.max = String(maxQ);
          row.dataset.katsayi = String(Number(t.katsayi ?? 0));

          row.innerHTML = `
            <div class="lgsTestName">${testName}</div>
            <div><input class="smallInput inpD" inputmode="numeric" pattern="[0-9]*" placeholder="0" /></div>
            <div><input class="smallInput inpY" inputmode="numeric" pattern="[0-9]*" placeholder="0" /></div>
            <div><input class="smallInput inpN" inputmode="decimal" placeholder="0" /></div>
          `;

          const inpD = row.querySelector(".inpD");
          const inpY = row.querySelector(".inpY");
          const inpN = row.querySelector(".inpN");

          const onChange = (who) => {
            row.dataset.last = who;

            const max = Number(row.dataset.max || 0);
            const ratio = Number(lgsData.yanlis_dogru_orani ?? 3);

            let d = toNum(inpD.value);
            let y = toNum(inpY.value);
            let n = toNum(inpN.value);

            const last = row.dataset.last;

            // Kullanıcı NET'e yazarsa: D/Y temizlenir, NET clamp edilir
            if (last === "n" && Number.isFinite(n)) {
              n = clamp(n, 0, max);
              inpN.value = fmt2(n);
              inpD.value = "";
              inpY.value = "";
            } else {
              if (Number.isFinite(d)) d = clamp(d, 0, max);
              if (Number.isFinite(y)) y = clamp(y, 0, max);

              // D+Y max'ı aşmasın
              if (Number.isFinite(d) && Number.isFinite(y) && (d + y) > max) {
                if (last === "d") d = max - y;
                if (last === "y") y = max - d;
                d = clamp(d, 0, max);
                y = clamp(y, 0, max);
              }

              inpD.value = Number.isFinite(d) ? String(Math.trunc(d)) : (inpD.value.trim() ? inpD.value : "");
              inpY.value = Number.isFinite(y) ? String(Math.trunc(y)) : (inpY.value.trim() ? inpY.value : "");

              // NET hesap (D/Y varsa)
              if (Number.isFinite(d) || Number.isFinite(y)) {
                const dd = Number.isFinite(d) ? d : 0;
                const yy = Number.isFinite(y) ? y : 0;
                const net = dd - (yy / ratio);
                const netClamped = clamp(net, 0, max);
                inpN.value = fmt2(netClamped);
              } else {
                // D/Y yoksa NET serbest
                if (Number.isFinite(n)) {
                  n = clamp(n, 0, max);
                  inpN.value = fmt2(n);
                }
              }
            }

            recalcTotalsOnly();
          };

          inpD.addEventListener("input", () => onChange("d"));
          inpY.addEventListener("input", () => onChange("y"));
          inpN.addEventListener("input", () => onChange("n"));

          rowsWrap.appendChild(row);
        });

        // İl seçenekleri
        const okullar = pickArr(lgsData, ["okullar","schools","liseler","lise_listesi","kurumlar","veri","data"]);
        const getIl = (o) => (o?.il ?? o?.IL ?? o?.Il ?? o?.city ?? o?.sehir ?? o?.şehir ?? o?.province ?? "").toString().trim();
    const iller = Array.from(new Set(okullar.map(getIl).filter(Boolean)))
          .sort((a,b)=>a.localeCompare(b,"tr"));

        ilSelect.innerHTML = "";
        iller.forEach(il => {
          const opt = document.createElement("option");
          opt.value = il;
          opt.textContent = il;
          ilSelect.appendChild(opt);
        });
        if (iller.includes("İSTANBUL")) ilSelect.value = "İSTANBUL";

        btnCalc && btnCalc.addEventListener("click", lgs_calculate);

        recalcTotalsOnly();
      }

      function getRows(){
        return rowsWrap ? Array.from(rowsWrap.querySelectorAll(".lgsRow")) : [];
      }

      function recalcTotalsOnly(){
        const rows = getRows();
        let sumD = 0, sumY = 0, sumN = 0;

        rows.forEach(r => {
          const max = Number(r.dataset.max || 0);
          const ratio = Number(lgsData?.yanlis_dogru_orani ?? 3);

          const dEl = r.querySelector(".inpD");
          const yEl = r.querySelector(".inpY");
          const nEl = r.querySelector(".inpN");

          const d = toNum(dEl?.value);
          const y = toNum(yEl?.value);
          const n = toNum(nEl?.value);

          if (Number.isFinite(d)) sumD += clamp(d, 0, max);
          if (Number.isFinite(y)) sumY += clamp(y, 0, max);

          if (Number.isFinite(n)) sumN += clamp(n, 0, max);
          else {
            const dd = Number.isFinite(d) ? d : 0;
            const yy = Number.isFinite(y) ? y : 0;
            if (dd || yy) sumN += clamp(dd - (yy/ratio), 0, max);
          }
        });

        outDogru && (outDogru.value = fmt2(sumD));
        outYanlis && (outYanlis.value = fmt2(sumY));
        outNet && (outNet.value = fmt2(sumN));
      }

      function nearestIndex(arr, x){
        let bestI = 0;
        let bestD = Infinity;
        for (let i=0;i<arr.length;i++){
          const d = Math.abs(arr[i]-x);
          if (d < bestD){ bestD = d; bestI = i; }
        }
        return bestI;
      }

      function lgs_calculate(){
        if (!lgsData) { noteEl.textContent = "lgs.json henüz yüklenmedi."; return; }

        const rows = getRows();
        const base = Number(lgsData.base_puan ?? 0);

        let puan = base;

        rows.forEach(r => {
          const max = Number(r.dataset.max || 0);
          const kats = Number(r.dataset.katsayi || 0);
          const nEl = r.querySelector(".inpN");
          let net = toNum(nEl?.value);
          if (!Number.isFinite(net)) net = 0;
          net = clamp(net, 0, max);
          puan += net * kats;
        });

        outPuan && (outPuan.value = fmtPuan(puan));

        const tab = lgsData.yuzdelik_tablosu || {};
        const puanArr = Array.isArray(tab.puan) ? tab.puan : [];
        const yuzArr = Array.isArray(tab.yuzdelik) ? tab.yuzdelik : [];
        const nakilArr = Array.isArray(tab.nakil_yuzdelik) ? tab.nakil_yuzdelik : [];

        if (puanArr.length && yuzArr.length){
          const i = nearestIndex(puanArr, puan);
          const yuz = yuzArr[i];
          outYuz && (outYuz.value = fmt2(yuz));
          renderLists(Number(yuz), Number(nakilArr[i]));
          listsWrap && (listsWrap.style.display = "");
        } else {
          outYuz && (outYuz.value = "");
          noteEl.textContent = "yüzdelik_tablosu bulunamadı.";
          listsWrap && (listsWrap.style.display = "none");
        }
      }

      function renderLists(yuzdelik, nakilYuz){
        const il = (ilSelect?.value || "").toString().trim();
        const okullar = pickArr(lgsData, ["okullar","schools","liseler","lise_listesi","kurumlar","veri","data"]);

        const birinci = okullar
          .filter(o => (o.il || "").toString().trim() === il && Number.isFinite(Number(o.yuzdelik_2025)))
          .map(o => ({...o, diff: Math.abs(Number(o.yuzdelik_2025) - yuzdelik)}))
          .sort((a,b)=>a.diff-b.diff)
          .slice(0, 12);

        const nakil = okullar
          .filter(o => (o.il || "").toString().trim() === il && Number.isFinite(Number(o.nakil_yuzdelik_2025)))
          .map(o => ({...o, diff: Math.abs(Number(o.nakil_yuzdelik_2025) - nakilYuz)}))
          .sort((a,b)=>a.diff-b.diff)
          .slice(0, 12);

        fillTable("tblBirinci", birinci, "yuzdelik_2025");
        fillTable("tblNakil", nakil, "nakil_yuzdelik_2025");
      }

      function fillTable(tblId, rows, yuzKey){
        const tbl = document.getElementById(tblId);
        if (!tbl) return;
        const tbody = tbl.querySelector("tbody");
        if (!tbody) return;

        tbody.innerHTML = "";
        rows.forEach(r => {
          const tr = document.createElement("tr");

          const okul = (r.okul ?? r.OKUL ?? r.ad ?? r.name ?? r.kurum ?? "").toString();
          const puan = Number(r.puan_2025 ?? r.puan ?? r.score ?? r.puan2025);
          const yuz = Number(r[yuzKey] ?? r.yuzdelik ?? r.yuzde ?? r.percentile ?? r.percentage);

          const trendText = (r.trend_2025 || r.trend || r.talep || "").toString();

          tr.innerHTML = `
            <td class="schoolName">${okul}</td>
            <td class="colNum">${Number.isFinite(puan) ? fmtPuan(puan) : ""}</td>
            <td class="colNum">${Number.isFinite(yuz) ? fmt2(yuz) : ""}</td>
            <td class="colTrend" data-trend-cell>${trendText}</td>
          `;
          tbody.appendChild(tr);
        });

        applyTrendColors(tbl);
      }

      // default: YKS açık
      setExam("YKS");
    })();
  </script>


<!-- LGS_SAFE_PLUGIN_START -->
<script>
(function(){
  "use strict";
  if (window.__LGS_SAFE_PLUGIN__) return;
  window.__LGS_SAFE_PLUGIN__ = true;

  // Helpers
  const $ = (id)=>document.getElementById(id);
  const num = (v)=>{
    if (v===null||v===undefined) return NaN;
    if (typeof v==="number") return v;
    const s = String(v).trim().replace(",",".");
    if (!s) return NaN;
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  };
  const fmt2 = (n)=>{
    if (!Number.isFinite(n)) return "";
    return n.toFixed(2).replace(".", ",");
  };
  const uniq = (arr)=>Array.from(new Set(arr));
  const safeText = (s)=> (s===null||s===undefined) ? "" : String(s);

  function getOkulFields(o){
    // Support both normalized keys and Excel-header keys
    const il = o["il"] ?? o["İl Adı"] ?? o["Il"] ?? o["Il Adı"] ?? o["İl"] ?? o["IL"] ?? "";
    const okul = o["okul"] ?? o["Okul Adı"] ?? o["Okul"] ?? o["OKUL"] ?? "";
    const puan = o["puan2025"] ?? o["2025 Taban Puan"] ?? o["TABAN_PUAN"] ?? o["puan"] ?? null;
    const yuz = o["yuzdelik2025"] ?? o["2025 En Düşük % Dilim"] ?? o["YUZDELIK"] ?? o["yuzdelik"] ?? null;
    const nakilYuz = o["yuzdelikNakil2025"] ?? o["2025 En Düşük Nakil Sonrası % Dilim"] ?? o["NAKIL_YUZDELIK"] ?? o["nakil_yuzdelik"] ?? null;
    const aciklama = o["aciklama"] ?? o["AÇIKLAMA-1"] ?? o["AÇIKLAMA-2"] ?? o["aciklama1"] ?? "";
    return {il, okul, puan, yuz, nakilYuz, aciklama};
  }

  function nearestIndex(sortedArr, x){
    // sorted ascending
    let lo=0, hi=sortedArr.length-1;
    if (hi<0) return -1;
    if (x<=sortedArr[0]) return 0;
    if (x>=sortedArr[hi]) return hi;
    while (hi-lo>1){
      const mid = (lo+hi)>>1;
      if (sortedArr[mid]===x) return mid;
      if (sortedArr[mid]<x) lo=mid; else hi=mid;
    }
    // choose closer
    return (Math.abs(sortedArr[lo]-x) <= Math.abs(sortedArr[hi]-x)) ? lo : hi;
  }

  function buildIlOptions(lgsData){
    const sel = $("lgsIl");
    if (!sel) return;
    const iller = (Array.isArray(lgsData.iller) && lgsData.iller.length)
      ? lgsData.iller
      : uniq((lgsData.okullar||[]).map(o=>getOkulFields(o).il).filter(Boolean)).sort((a,b)=>a.localeCompare(b,"tr",{sensitivity:"base"}));

    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "İL SEÇ";
    sel.appendChild(opt0);

    for (const il of iller){
      const op = document.createElement("option");
      op.value = il;
      op.textContent = il;
      sel.appendChild(op);
    }
  }

  function renderLists(lgsData, candIl, candYuz){
    const wrap = $("lgsLists");
    if (!wrap) return;

    const okullar = (lgsData.okullar||[]).map(o=>({raw:o, f:getOkulFields(o)}))
      .filter(x=>x.f.okul && x.f.il);

    const byIl = okullar.filter(x=>x.f.il === candIl);

    // Place 1: use yuz
    const list1 = byIl
      .map(x=>{
        const y = num(x.f.yuz);
        return {...x, y};
      })
      .filter(x=>Number.isFinite(x.y) && x.y >= candYuz)
      .sort((a,b)=>a.y-b.y || num(b.f.puan)-num(a.f.puan))
      .slice(0,24);

    // Nakil: use nakilYuz (fallback to yuz)
    const list2 = byIl
      .map(x=>{
        const y = num(x.f.nakilYuz);
        const y2 = Number.isFinite(y)?y:num(x.f.yuz);
        return {...x, y:y2};
      })
      .filter(x=>Number.isFinite(x.y) && x.y >= candYuz)
      .sort((a,b)=>a.y-b.y || num(b.f.puan)-num(a.f.puan))
      .slice(0,24);

    function rowHTML(x){
      const puan = num(x.f.puan);
      const ac = safeText(x.f.aciklama);
      const puanS = Number.isFinite(puan) ? fmt2(puan) : "";
      const yuzS = Number.isFinite(x.y) ? fmt2(x.y) : "";
      const acS = ac ? ` <span style="opacity:.75;">${ac}</span>` : "";
      return `<tr>
        <td style="text-align:left;">${safeText(x.f.okul)}${acS}</td>
        <td class="colNum">${puanS}</td>
        <td class="colNum">${yuzS}</td>
      </tr>`;
    }

    // There are already two tables in HTML under lgsLists. We'll just fill their TBODYs if present.
    const tbodies = wrap.querySelectorAll("tbody");
    if (tbodies.length >= 2){
      tbodies[0].innerHTML = list1.map(rowHTML).join("") || `<tr><td colspan="3" style="opacity:.7;">Liste yok.</td></tr>`;
      tbodies[1].innerHTML = list2.map(rowHTML).join("") || `<tr><td colspan="3" style="opacity:.7;">Liste yok.</td></tr>`;
    } else {
      // fallback render
      wrap.innerHTML = `
        <div style="margin-top:10px;font-weight:700;">BİRİNCİ YERLEŞTİRME DÖNEMİNDE</div>
        <table class="lgsTable" style="width:100%;"><tbody>${list1.map(rowHTML).join("")}</tbody></table>
        <div style="margin-top:14px;font-weight:700;">SON NAKİL DÖNEMİNDE</div>
        <table class="lgsTable" style="width:100%;"><tbody>${list2.map(rowHTML).join("")}</tbody></table>
      `;
    }
  }

  function computeLgs(lgsData){
    const note = $("lgsNote");
    const outPuan = $("lgsPuan");
    const outYuz = $("lgsYuzdelik");
    const ilSel = $("lgsIl");

    if (note) note.textContent = "";

    // Collect nets from table inputs
    const rows = $("lgsRows") ? $("lgsRows").querySelectorAll("tr[data-test]") : [];
    let totalDog=0, totalYan=0, totalNet=0;

    // Build max_soru map from lgsData.tests
    const maxMap = {};
    const kMap = {};
    if (Array.isArray(lgsData.tests)){
      for (const t of lgsData.tests){
        const key = safeText(t.test).toUpperCase();
        maxMap[key] = Number(t.max_soru);
        kMap[key] = Number(t.katsayi);
      }
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    for (const tr of rows){
      const test = safeText(tr.getAttribute("data-test")).toUpperCase();
      const maxS = maxMap[test] ?? 0;
      const katsayi = kMap[test] ?? 0;

      const iD = tr.querySelector('input[data-field="dogru"]');
      const iY = tr.querySelector('input[data-field="yanlis"]');
      const iN = tr.querySelector('input[data-field="net"]');

      const d = Number.isFinite(num(iD?.value)) ? num(iD.value) : NaN;
      const y = Number.isFinite(num(iY?.value)) ? num(iY.value) : NaN;
      const n = Number.isFinite(num(iN?.value)) ? num(iN.value) : NaN;

      let dog = 0, yan = 0, net = 0;

      const hasDY = (iD && iY && (String(iD.value).trim()!=="" || String(iY.value).trim()!==""));
      const hasN = (iN && String(iN.value).trim()!=="");

      if (hasDY){
        dog = Number.isFinite(d) ? d : 0;
        yan = Number.isFinite(y) ? y : 0;

        // enforce non-negative and integer-like
        dog = clamp(dog, 0, maxS);
        yan = clamp(yan, 0, maxS);

        if (dog + yan > maxS){
          if (note) note.textContent = `${test}: Doğru+Yanlış ${maxS} sınırını aşamaz.`;
          // hard clamp by reducing yan
          yan = clamp(maxS - dog, 0, maxS);
        }

        net = dog - (yan / (Number(lgsData.yanlis_dogru_orani) || 3));
        // net cannot exceed maxS
        net = clamp(net, 0, maxS);

        if (iD) iD.value = String(Math.trunc(dog));
        if (iY) iY.value = String(Math.trunc(yan));
        if (iN) iN.value = fmt2(net);
      } else if (hasN){
        // allow direct net (küsuratlı), but cap
        net = Number.isFinite(n) ? n : 0;
        net = clamp(net, 0, maxS);
        if (iN) iN.value = fmt2(net);
        if (iD) iD.value = "";
        if (iY) iY.value = "";
      } else {
        if (iN) iN.value = "";
      }

      totalDog += dog;
      totalYan += yan;
      totalNet += net;

      // accumulate score
      tr.__lgsScorePart = net * katsayi;
    }

    // totals row is already computed in existing script; but we'll set if ids exist
    const tdDog = $("lgsDogruTop");
    const tdYan = $("lgsYanlisTop");
    const tdNet = $("lgsNetTop");
    if (tdDog) tdDog.value = fmt2(totalDog);
    if (tdYan) tdYan.value = fmt2(totalYan);
    if (tdNet) tdNet.value = fmt2(totalNet);

    // compute puan
    let puan = Number(lgsData.base_puan) || 0;
    for (const tr of rows){
      puan += (Number(tr.__lgsScorePart) || 0);
    }
    // cap 500
    puan = Math.min(500, puan);
    if (outPuan) outPuan.value = fmt2(puan);

    // compute yuzdelik from puan2yuzdelik
    const tab = lgsData.puan2yuzdelik || {};
    const scores = Array.isArray(tab.scores) ? tab.scores.map(Number) : [];
    const yuzs = Array.isArray(tab.yuzdelikler) ? tab.yuzdelikler.map(Number) : [];
    if (scores.length && yuzs.length && scores.length===yuzs.length){
      const idx = nearestIndex(scores, puan);
      const yuz = yuzs[idx];
      if (outYuz) outYuz.value = fmt2(yuz);
      const il = ilSel ? ilSel.value : "";
      if (il){
        renderLists(lgsData, il, yuz);
      }
    } else {
      if (note) note.textContent = "yüzdelik_tablosu bulunamadı.";
      if (outYuz) outYuz.value = "";
    }
  }

  async function loadLgsData(){
    const note = $("lgsNote");
    try{
      const r = await fetch("lgs.json?v="+Date.now());
      if (!r.ok) throw new Error("HTTP "+r.status);
      const data = await r.json();
      window.__LGS_DATA__ = data;
      buildIlOptions(data);
      if (note) note.textContent = "";
      return data;
    }catch(err){
      if (note) note.textContent = "Veri: yüklenemedi ❌ ("+err.message+")";
      throw err;
    }
  }

  // Hook
  document.addEventListener("DOMContentLoaded", function(){
    const btn = $("btnLgsHesapla");
    if (!btn) return;

    // load once
    let ready = null;
    btn.addEventListener("click", async function(){
      try{
        const data = window.__LGS_DATA__ || await (ready || (ready = loadLgsData()));
        computeLgs(data);
      }catch(_e){}
    });

    // populate on mode switch if LGS panel becomes visible
    const btnLgs = $("btnLgs");
    if (btnLgs){
      btnLgs.addEventListener("click", async function(){
        try{
          await (window.__LGS_DATA__ || await (ready || (ready = loadLgsData())));
        }catch(_e){}
      });
    }
  });
})();
</script>
<!-- LGS_SAFE_PLUGIN_END -->

</body>
</html>
